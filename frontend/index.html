<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/style.css">
    <title>Your Website</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<!-- Container for the navigation bar -->
<div id="navbar-container"></div>
<!-- Include the script to load the navigation bar -->
<script src="/static/navbar.js"></script>

User<input id="username"><br>
password<input id="password"><br>
role type:
    <select id="role">
     <option value="0">user (cant add a book)</option>
     <option value="1" selected>manager</option>
<input type="file" id="fileInput"><br>
<button onclick="login()">Login</button>
<button onclick="logout()">Logout</button>
<button onclick="register()">register</button>
<hr>

    </select>
    <div id="gret">Welcome</div>
    <div id="uimage">image</div>
    <h1>Car details</h1>
    name<input id="book_name"><br>
    riter<input id="riter"><br>
    date <input id="date" ><br>
    <button onclick="addBook()">Ad a book</button>
    <button onclick="getBooks()">books!</button>
    <button onclick="getUsers()">users</button>
    <div id="booksContainer">
        <table border="1">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Writer</th>
                    <th>Date</th>
                    <th>Lend?</th>
                    <th>Delete</th>
                    <th>Update</th>
                    <th>Return?</th>
                </tr>
            </thead>
            <tbody id="booksTableBody"></tbody>
        </table>
    </div>

    <br>
    <div id="usersContainer">
        <table border="1">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Password</th>
                    <th>Role</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="usersTableBody"></tbody>
        </table>
    </div>

    <script>
        const MY_SERVER = "http://127.0.0.1:5000"

        const addBook = async () => {
    const bookName = document.getElementById("book_name").value;
    const riter = document.getElementById("riter").value;
    const date = document.getElementById("date").value;

    const token = sessionStorage.getItem("access_token");

    try {
        const response = await axios.post(
            `${MY_SERVER}/addbook`,
            { book_name: bookName, riter: riter, date: date },
            {
                headers: {
                    Authorization: `Bearer ${token}`,
                    'Content-Type': 'application/json', // Set Content-Type header
                },
            }
        );

        console.log(response.data);
        // Handle the response as needed (e.g., show a success message, update UI, etc.)

    } catch (error) {
        console.error("Error adding book:", error.response ? error.response.data : error.message);
        // Handle the error accordingly (e.g., show an error message)
    }
};


const getBooks = async () => {
    try {
        const token = sessionStorage.getItem("access_token");
        const response = await axios.get(`${MY_SERVER}/getbooks`, {
            headers: {
                Authorization: `Bearer ${token}`
            }
        });

        const booksList = response.data.books;
        updateBooksTable(booksList);

    } catch (error) {
        console.error("Error fetching books:", error.response ? error.response.data : error.message);
        // Handle the error accordingly
    }
};

const updateBooksTable = (booksList) => {
    const booksTableBody = document.getElementById("booksTableBody");

    // Clear the existing content
    booksTableBody.innerHTML = "";

    // Create and append new rows for each book
    booksList.forEach(book => {
        const row = booksTableBody.insertRow();

        // Add cells for book properties
        const bookNameCell = row.insertCell(0);
        bookNameCell.textContent = book.book_name;

        const writerCell = row.insertCell(1);
        writerCell.textContent = book.riter;

        const dateCell = row.insertCell(2);
        dateCell.textContent = book.date;

        const lendStatusCell = row.insertCell(3);
        lendStatusCell.textContent = book.lend ? 'Lent' : 'Not Lent';

        // Add cell for delete button
        const deleteButtonCell = row.insertCell(4);
        const deleteButton = document.createElement("button");
        deleteButton.textContent = "Delete";
        deleteButton.onclick = () => deleteBook(book.book_id);
        deleteButtonCell.appendChild(deleteButton);

        // Add cell for lending button
        const lendButtonCell = row.insertCell(5);
        const lendButton = document.createElement("button");
        lendButton.textContent = "Lend";
        if (book.lend_info) {
            lendButton.disabled = true;  // Disable lending button for lent books
        } else {
            lendButton.onclick = () => lendBook(book.book_id);
        }
        lendButtonCell.appendChild(lendButton);

        // Add cell for returning button
        const returnButtonCell = row.insertCell(6);
        const returnButton = document.createElement("button");
        returnButton.textContent = "Return";

        // Check if the book is currently lent
        if (book.lend) {
            returnButton.onclick = () => returnBook(book.book_id);
        } else {
            returnButton.disabled = true;  // Disable return button for books that are not lent
        }

        returnButtonCell.appendChild(returnButton);
    });
};

const deleteBook = async (bookId) => {
    const token = sessionStorage.getItem("access_token");

    try {
        const response = await axios.delete(`${MY_SERVER}/deletebook/${bookId}`, {
            headers: {
                Authorization: `Bearer ${token}`
            }
        });

        console.log(response.data);
        // Refresh the books list after deletion
        getBooks();
    } catch (error) {
        console.error("Error deleting book:", error.response ? error.response.data : error.message);
        // Handle the error accordingly
    }
};



const returnBook = async (lendId) => {
    const token = sessionStorage.getItem("access_token");

    try {
        const response = await axios.post(`${MY_SERVER}/returnbook/${lendId}`, null, {
            headers: {
                Authorization: `Bearer ${token}`
            }
        });

        console.log(response.data);
        // Refresh the books list after returning
        getBooks();
    } catch (error) {
        console.error("Error returning book:", error.response ? error.response.data : error.message);
        // Handle the error accordingly
    }
};


        const updateBook = (bookId) => {
    // Assuming you have a form with id "updateBookForm" in your HTML
    const updateForm = document.getElementById("updateBookForm");

    // Get the book details from the user or retrieve them from the existing data
    const updatedName = prompt("Enter updated book name:");
    const updatedRiter = prompt("Enter updated writer:");
    const updatedDate = prompt("Enter updated date:");

    const token = sessionStorage.getItem("access_token");

    axios.put(`${MY_SERVER}/updatebook/${bookId}`, {
        name: updatedName,
        riter: updatedRiter,
        date: updatedDate
    }, {
        headers: {
            Authorization: `Bearer ${token}`
        }
    }).then(response => {
        console.log(response.data);
        // Refresh the book list after updating
        getBooks();
    }).catch(error => {
        console.error("Error updating book:", error.response ? error.response.data : error.message);
        // Handle the error accordingly
    });

};

const lendBook = async (bookId) => {
    const token = sessionStorage.getItem("access_token");
console.log(token);
    try {
        const response = await axios.post(
            `${MY_SERVER}/lendbook`,
            { book_id: bookId },
            {
                headers: {
                    Authorization: `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
            }
        );

        console.log(response.data);
        // Handle the response as needed (e.g., show a success message, update UI, etc.)
        // You might want to refresh the books list or update the specific book's status in the UI.

    } catch (error) {
        console.error("Error lending book:", error.response ? error.response.data : error.message);
        // Handle the error accordingly (e.g., show an error message)
    }
};





const getUsers = async () => {
            try {
                const token = sessionStorage.getItem("access_token");
                const response = await axios.get(`${MY_SERVER}/getusers`, {
                    headers: {
                        Authorization: `Bearer ${token}`
                    }
                });

                const usersList = response.data.users;
                updateUsersTable(usersList);

            } catch (error) {
                console.error("Error fetching users:", error.response ? error.response.data : error.message);
                // Handle the error accordingly
            }
        };

        const updateUsersTable = (usersList) => {
            const usersTableBody = document.getElementById("usersTableBody");

            // Clear the existing content
            usersTableBody.innerHTML = "";

            // Create and append new rows for each user
            usersList.forEach(user => {
                const row = usersTableBody.insertRow();

                // Add cells for user properties
                const usernameCell = row.insertCell(0);
                usernameCell.textContent = user.username;

                const passwordCell = row.insertCell(1);
                passwordCell.textContent = user.password; // Note: You might want to hide or mask the password for security reasons

                const roleCell = row.insertCell(2);
                roleCell.textContent = user.role;

                // Add cell for actions (delete and update buttons)
                const actionsCell = row.insertCell(3);
                const deleteButton = document.createElement("button");
                deleteButton.textContent = "Delete";
                deleteButton.onclick = () => deleteUser(user.id);
                actionsCell.appendChild(deleteButton);

                const updateButton = document.createElement("button");
                updateButton.textContent = "Update";
                updateButton.onclick = () => updateUser(user.id);
                actionsCell.appendChild(updateButton);
            });
        };

        const deleteUser = async (userId) => {
    try {
        const token = sessionStorage.getItem("access_token");
        const response = await axios.delete(`${MY_SERVER}/deleteuser/${userId}`, {
            headers: {
                Authorization: `Bearer ${token}`
            }
        });

        console.log(response.data.message);  // Log the server response message
        // Refresh the user list after deletion
        getUsers();
    } catch (error) {
        console.error("Error deleting user:", error.response ? error.response.data : error.message);
        // Handle the error accordingly
    }
};



        const updateUser = (userId) => {
            // Implement the update functionality as needed
            console.log(`Update user with ID ${userId}`);
        };









        const login = async () => {
            res = await axios.post(`${MY_SERVER}/login`, { username: username.value, password: password.value })
            console.log(res.data);
            uimage.innerHTML = `<img src=${res.data.image_url}>`
            gret.innerHTML = "<h1>Welcome mr. " + res.data.username
            sessionStorage.setItem("access_token", res.data.access_token)
        }
        const logout = () => {
            sessionStorage.setItem("access_token", "")
        }
        const register = async () => {
            try {
                const fileInput = document.getElementById('fileInput');
                const file = fileInput.files[0];

                const formData = new FormData();
                formData.append('file', file);
                formData.append('username', username.value);
                formData.append('password', password.value);
                formData.append('role', role.value);

                const config = {
                    headers: {
                        'Content-Type': 'multipart/form-data',
                    },
                };

                const res = await axios.post(`${MY_SERVER}/register`, formData, config);
                console.log(res.data);
                sessionStorage.setItem("access_token", res.data.access_token);
            } catch (error) {
                console.error('Error during registration:', error);
            }
        };
        

        </script>




</body>
</html>
