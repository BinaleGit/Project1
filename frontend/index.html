<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Website</title>
    <!-- Include Axios library for making HTTP requests -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<style>
    table {
        border-collapse: collapse;
        width: 100%;
    }

    th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }

    th {
        background-color: #f2f2f2;
    }

    tr:nth-child(even) {
        background-color: #f2f2f2;
    }

    tr:hover {
        background-color: #ddd;
    }

    .action-buttons {
        display: flex;
        justify-content: space-between;
    }

    .action-buttons button {
        margin: 5px;
        padding: 5px 10px;
        border: none;
        background-color: #4CAF50;
        color: white;
        cursor: pointer;
        border-radius: 4px;
    }

    .action-buttons button:hover {
        background-color: #45a049;
    }
</style>

<style>
    /* CSS styles for better appearance */
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
    }

    header {
        background-color: #333;
        color: #fff;
        padding: 10px 0;
    }

    nav ul {
        list-style-type: none;
        margin: 0;
        padding: 0;
    }

    nav ul li {
        display: inline;
        margin-right: 20px;
    }

    nav ul li a {
        text-decoration: none;
        color: #fff;
    }

    .content {
        padding: 20px;
    }
</style>
<body>
    <!-- Header with navigation -->
    <header>
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                <!-- Add more navigation links as needed -->
            </ul>
        </nav>
    </header>

    <!-- User login and registration form -->
    User: <input id="username"><br>
    Password: <input id="password"><br>
    Role Type:
    <select id="role">
        <option value="0">User (Cannot Add a Book)</option>
        <option value="1" selected>Manager</option>
    </select><br>
    <!-- File input for user image -->
    <input type="file" id="fileInput"><br>
    <!-- Buttons for login, logout, and registration -->
    <button onclick="login()">Login</button>
    <button onclick="logout()">Logout</button>
    <button onclick="register()">Register</button>
    <!-- Container to display user greeting and image -->
    <div id="gret">Welcome</div>
    <div id="uimage">Image</div>

    <!-- Section for managing books -->
    <h1>Book Details</h1>
    Name: <input id="book_name"><br>
    Writer: <input id="riter"><br>
    Date: <input type="date" id="date"><br>
    <!-- Buttons for adding books, fetching books, and fetching users -->
    <button onclick="addBook()">Add a Book</button>
    <button onclick="getBooks()">Fetch Books</button>
    <button onclick="getUsers()">Fetch Users</button>

    <!-- Container to display books -->
    <div id="booksContainer">
        <table border="1">
            <thead>
                <tr>
                    <th>Book Name</th>
                    <th>Writer</th>
                    <th>Publish Date</th>
                    <th>Lend Out?</th>
                    <th>Lend By?</th>
                    <th>Delete</th>
                    <th>Lend</th>
                    <th>Return</th>
                    <th>Update</th> 

                </tr>
            </thead>
            <tbody id="booksTableBody"></tbody>
        </table>
    </div>

    <!-- Container to display users -->
    <div id="usersContainer">
        <table border="1">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Password</th>
                    <th>Role</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="usersTableBody"></tbody>
        </table>
    </div>

    <!-- JavaScript section for handling user interactions -->
    <script>
        // Define the URL of your server
        const MY_SERVER = "http://127.0.0.1:5000"

        // Function to add a book
        // This function sends a POST request to the server to add a new book
        const addBook = async () => {
            // Get book details from input fields
            const bookName = document.getElementById("book_name").value;
            const riter = document.getElementById("riter").value;
            const date = document.getElementById("date").value;

            // Retrieve the access token from session storage
            const token = sessionStorage.getItem("access_token");

            try {
                // Send a POST request to the server to add the book
                const response = await axios.post(
                    `${MY_SERVER}/addbook`,
                    { book_name: bookName, riter: riter, date: date },
                    {
                        headers: {
                            Authorization: `Bearer ${token}`,
                            'Content-Type': 'application/json', // Set Content-Type header
                        },
                    }
                );

                console.log(response.data);
                // Handle the response as needed (e.g., show a success message, update UI, etc.)

            } catch (error) {
                console.error("Error adding book:", error.response ? error.response.data : error.message);
                // Handle the error accordingly (e.g., show an error message)
            }
        };

        // Function to fetch all books
        // This function sends a GET request to the server to fetch all books
        const getBooks = async () => {
            try {
                // Retrieve the access token from session storage
                const token = sessionStorage.getItem("access_token");
                // Send a GET request to the server to fetch all books
                const response = await axios.get(`${MY_SERVER}/getbooks`, {
                    headers: {
                        Authorization: `Bearer ${token}`
                    }
                });

                // Retrieve the list of books from the server response
                const booksList = response.data.books;
                // Update the books table in the UI with the fetched books
                updateBooksTable(booksList);

            } catch (error) {
                console.error("Error fetching books:", error.response ? error.response.data : error.message);
                // Handle the error accordingly
            }
        };
        const deleteBook = async (bookId) => {
    const token = sessionStorage.getItem("access_token");

    try {
        const response = await axios.delete(`${MY_SERVER}/deletebook/${bookId}`, {
            headers: {
                Authorization: `Bearer ${token}`
            }
        });

        console.log(response.data);
        // Refresh the books list after deletion
        getBooks();
    } catch (error) {
        console.error("Error deleting book:", error.response ? error.response.data : error.message);
        // Handle the error accordingly
    }
};

const updateUserInfo = async (userId) => {
    // Retrieve updated user details from the user
    const updatedUsername = prompt("Enter updated username:");
    // const updatedPassword = prompt("Enter updated password:"); // Prompt the user to enter the new password
    const updatedRole = prompt("Enter updated role:");

    // Prepare the updated user object
    const updatedUser = {
        username: updatedUsername,
        password: updatedPassword, // Include the new password in the updated user object
        role: updatedRole
    };

    try {
        const token = sessionStorage.getItem("access_token");

        // Make a PUT request to the backend API to update the user
        const response = await axios.put(`${MY_SERVER}/updateuser/${userId}`, updatedUser, {
            headers: {
                Authorization: `Bearer ${token}`,
                'Content-Type': 'application/json',
            },
        });

        console.log(response.data);
        // Optionally, update the UI or display a success message
    } catch (error) {
        console.error("Error updating user:", error.response ? error.response.data : error.message);
        // Handle the error accordingly (e.g., show an error message)
    }
};


const updateBook = async (bookId) => {
    const updatedName = prompt("Enter updated book name:");
    const updatedRiter = prompt("Enter updated writer:");
    const updatedDate = prompt("Enter updated date:");

    const token = sessionStorage.getItem("access_token");

    try {
        const response = await axios.put(`${MY_SERVER}/updatebook/${bookId}`, {
            name: updatedName,
            riter: updatedRiter,
            date: updatedDate
        }, {
            headers: {
                Authorization: `Bearer ${token}`
            }
        });

        console.log(response.data);
        // Refresh the books list after updating
        getBooks();
    } catch (error) {
        console.error("Error updating book:", error.response ? error.response.data : error.message);
        // Handle the error accordingly
    }
};


const updateBooksTable = async (booksList) => {
    const booksTableBody = document.getElementById("booksTableBody");

    // Clear the existing content
    booksTableBody.innerHTML = "";

    // Create and append new rows for each book
    for (const book of booksList) {
        const row = booksTableBody.insertRow();

        // Add cells for book properties
        const bookNameCell = row.insertCell(0);
        bookNameCell.textContent = book.book_name;

        const writerCell = row.insertCell(1);
        writerCell.textContent = book.riter;

        const dateCell = row.insertCell(2);
        dateCell.textContent = book.date;

        const lendStatusCell = row.insertCell(3);
        lendStatusCell.textContent = book.lend ? 'Lent' : 'Not Lent';

        // Add cell for lender name
        const lenderCell = row.insertCell(4);
        lenderCell.textContent = book.lender; // Display lender name directly

        // Add cell for delete button
        const deleteButtonCell = row.insertCell(5);
        const deleteButton = document.createElement("button");
        deleteButton.textContent = "Delete";
        deleteButton.onclick = () => deleteBook(book.book_id);
        deleteButtonCell.appendChild(deleteButton);

        // Add cell for lending button
        const lendButtonCell = row.insertCell(6);
        const lendButton = document.createElement("button");
        lendButton.textContent = "Lend";
        lendButton.onclick = () => lendBook(book.book_id);
        lendButton.disabled = book.lend; // Disable button if book is already lent
        lendButtonCell.appendChild(lendButton);

        // Add cell for returning button
        const returnButtonCell = row.insertCell(7);
        const returnButton = document.createElement("button");
        returnButton.textContent = "Return";
        returnButton.onclick = () => returnBook(book.book_id);
        returnButton.disabled = !book.lend; // Disable button if book is not lent
        returnButtonCell.appendChild(returnButton);

        // Add cell for update button
        const updateButtonCell = row.insertCell(8);
        const updateButton = document.createElement("button");
        updateButton.textContent = "Update";
        updateButton.onclick = () => updateBook(book.book_id);
        updateButtonCell.appendChild(updateButton);
    }
};



const lendBook = async (bookId) => {
    const token = sessionStorage.getItem("access_token");

    try {
        const response = await axios.post(
            `${MY_SERVER}/lendbook`,
            { book_id: bookId },
            {
                headers: {
                    Authorization: `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
            }
        );

        console.log(response.data);
        // Handle the response as needed (e.g., show a success message, update UI, etc.)
        // You might want to refresh the books list or update the specific book's status in the UI.

    } catch (error) {
        console.error("Error lending book:", error.response ? error.response.data : error.message);
        // Handle the error accordingly (e.g., show an error message)
    }
};
const returnBook = async (bookId) => {
    const token = sessionStorage.getItem("access_token");

    try {
        const response = await axios.post(
            `${MY_SERVER}/returnbook/${bookId}`,
            null,
            {
                headers: {
                    Authorization: `Bearer ${token}`,
                },
            }
        );

        console.log(response.data);
        // Handle the response as needed (e.g., show a success message, update UI, etc.)
        // You might want to refresh the books list or update the specific book's status in the UI.

    } catch (error) {
        console.error("Error returning book:", error.response ? error.response.data : error.message);
        // Handle the error accordingly (e.g., show an error message)
    }
};


        // Function to fetch users from the server
const getUsers = async () => {
    try {
        // Retrieve the access token from session storage
        const token = sessionStorage.getItem("access_token");
        // Send a GET request to the server to fetch users
        const response = await axios.get(`${MY_SERVER}/getusers`, {
            headers: {
                Authorization: `Bearer ${token}`
            }
        });

        // Extract the list of users from the server response
        const usersList = response.data.users;
        // Update the users table in the UI with the fetched users
        updateUsersTable(usersList);

    } catch (error) {
        console.error("Error fetching users:", error.response ? error.response.data : error.message);
        // Handle the error accordingly
    }
};

// Function to update the users table in the UI
const updateUsersTable = (usersList) => {
    const usersTableBody = document.getElementById("usersTableBody");

    // Clear the existing content of the users table
    usersTableBody.innerHTML = "";

    // Iterate over the list of users and add each user to the table
    usersList.forEach(user => {
        const row = usersTableBody.insertRow();

        // Add cells for each property of the user
        const usernameCell = row.insertCell(0);
        usernameCell.textContent = user.username;

        const passwordCell = row.insertCell(1);
        passwordCell.textContent = user.password; // Note: You might want to hide or mask the password for security reasons

        const roleCell = row.insertCell(2);
        roleCell.textContent = user.role;

        // Add buttons for delete and update actions
        const actionsCell = row.insertCell(3);
        const deleteButton = document.createElement("button");
        deleteButton.textContent = "Delete";
        deleteButton.onclick = () => deleteUser(user.id); // Call deleteUser function with user ID
        actionsCell.appendChild(deleteButton);

        const updateButton = document.createElement("button");
        updateButton.textContent = "Update";
        updateButton.onclick = () => updateUserInfo(user.id); // Call updateUser function with user ID
        actionsCell.appendChild(updateButton);
    });
};
// Function to delete a user
const deleteUser = async (userId) => {
    try {
        // Retrieve the access token from session storage
        const token = sessionStorage.getItem("access_token");
        // Send a DELETE request to the server to delete the user with the specified ID
        const response = await axios.delete(`${MY_SERVER}/deleteuser/${userId}`, {
            headers: {
                Authorization: `Bearer ${token}`
            }
        });

        // Log the server response message
        console.log(response.data.message);
        // Refresh the user list after deletion
        getUsers();
    } catch (error) {
        console.error("Error deleting user:", error.response ? error.response.data : error.message);
        // Handle the error accordingly
    }
};


        // Other functions for deleting books, lending books, etc. go here...

        // Function to handle user login
        const login = async () => {
            try {
                // Send a POST request to the server with user credentials
                const response = await axios.post(`${MY_SERVER}/login`, { 
                    username: document.getElementById("username").value, 
                    password: document.getElementById("password").value 
                });
                // Update UI with user information
                document.getElementById("uimage").innerHTML = `<img src=${response.data.image_url}>`;
                document.getElementById("gret").innerHTML = "<h1>Welcome, " + response.data.username + "</h1>";
                // Store access token in session storage
                sessionStorage.setItem("access_token", response.data.access_token);
            } catch (error) {
                console.error('Error during login:', error);
            }
        };

        // Function to handle user logout
        const logout = () => {
            // Clear access token from session storage
            sessionStorage.setItem("access_token", "");
        };

        // Function to handle user registration
        const register = async () => {
            try {
                // Prepare form data including username, password, role, and image
                const formData = new FormData();
                formData.append('file', document.getElementById('fileInput').files[0]);
                formData.append('username', document.getElementById('username').value);
                formData.append('password', document.getElementById('password').value);
                formData.append('role', document.getElementById('role').value);

                // Send a POST request to the server for user registration
                const response = await axios.post(`${MY_SERVER}/register`, formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data',
                    },
                });
                // Store access token in session storage after successful registration
                sessionStorage.setItem("access_token", response.data.access_token);
            } catch (error) {
                console.error('Error during registration:', error);
            }
        };
    </script>
</body>
</html>
